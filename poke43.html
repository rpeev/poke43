<!DOCTYPE html>

<html lang="en" class="light sans-serif">
  <head>
    <meta charset="utf-8" />

    <title>Poke43</title>

    <link rel="stylesheet" href="https://unpkg.com/peek42@latest/monofur.css" />
    <link rel="stylesheet" href="https://unpkg.com/peek42@latest/peek42.css" />

    <style>
.flex-row-center {
  display: flex;
  flex-flow: row wrap;
  justify-content: center;
  align-items: center;
}

.light {
  background: #f5f5f5;
  color: black;
}

.sans-serif {
  font-family: Avenir, sans-serif;
}

.frame {
  border: 1px solid gray;
  border-radius: 0.5ex;
  box-shadow: 0 0 1em gray;
}

@keyframes fade-out-fade-in {
  0% { opacity: 1; }
  50% { opacity: 0; }
  100% { opacity: 1; }
}

.blink-smooth { animation: 1s ease 0.3s infinite fade-out-fade-in; }

.poke {
  min-height: 1.2em;
  margin-top: -1em;
  border: 1px solid gray;
  border-radius: 0.5ex;
  white-space: pre;
  font-size: 1.4em;
}

.poke-line-part1 {

}

.poke-line-caret {
  position: relative;
  left: -1px;
  border-right: 3px solid navy;
}

.poke-line-part2 {
  position: relative;
  left: -3px;
}

.keyboard {
  /*padding: 1ex;
  border: 1px solid gray;
  border-radius: 0.5ex;
  box-shadow: 0 0 1em gray;*/
}

.key {
  display: inline-flex;
  justify-content: center;
  align-items: center;
  width: 60px;
  height: 50px;
  border: 1px solid gray;
  border-radius: 0.5ex;
  font-size: 1.5em;
}

.key-character {
  border-color: green;
}

.key-punct {
  background: lightgray;
}

.key-delim {
  background: lightgray;
}

.key-symbol {
  width: 70px;
  height: 55px;
  background: #cedefa;
}

.key-danger {
  border-color: maroon !important;
}

.key-test {
  width: 70px;
  height: 70px;
  border-radius: 0.5ex;
}

.key-test-lg {
  width: 100px;
  height: 100px;
}

.key-flash {
  background: gray;
}

.key-flash0 {

}

.key-flash1 {

}

.key-flash2 {

}

.key-flash3 {

}

.key-flash4 {

}

.key-flash5 {

}

.key-flash6 {

}

.key-flash7 {

}

.key-flash8 {

}
    </style>

    <script src="https://unpkg.com/apivis@latest/apivis.js"></script>
    <script src="https://unpkg.com/peek42@latest/peek42.js"></script>
    <script src="https://unpkg.com/hammerjs@latest/hammer.js"></script>

    <script>
class Poke {
  constructor(el) {
    this._el = el;
    this._el.classList.add('poke');
    this._content = this._el.textContent;
    this._pos = this._content.length;
    this._part1 = document.createElement('span');
    this._caret = document.createElement('span');
    this._part2 = document.createElement('span');

    this._part1.classList.add('poke-line-part1');
    this._caret.classList.add('poke-line-caret');
    this._caret.classList.add('blink-smooth');
    this._part2.classList.add('poke-line-part2');

    this._el.textContent = '';
    this._el.appendChild(this._part1);
    this._el.appendChild(this._caret);
    this._el.appendChild(this._part2);

    this._update();
  }

  get _parts() {
    return [
      this._content.slice(0, this._pos),
      this._content.slice(this._pos)
    ];
  }

  _update() {
    let [part1, part2] = this._parts;

    this._part1.textContent = part1;
    this._part2.textContent = part2;
  }

  noop() {}

  moveBackward() {
    if (this._pos === 0) {
      throw new RangeError('Cannot move before start');
    }

    this._pos -= 1;
    this._update();
  }

  moveForward() {
    if (this._pos === this._content.length) {
      throw new RangeError('Cannot move past end');
    }

    this._pos += 1;
    this._update();
  }

  deleteBackward() {
    if (this._pos === 0) {
      throw new RangeError('Cannot delete before start');
    }

    this._content = `${this._content.slice(0, this._pos - 1)}${this._content.slice(this._pos)}`;
    this._pos -= 1;
    this._update();
  }

  deleteForward() {
    if (this._pos === this._content.length) {
      throw new RangeError('Cannot delete past end');
    }

    this._content = `${this._content.slice(0, this._pos)}${this._content.slice(this._pos + 1)}`;
    this._update();
  }

  insert(str) {
    this._content = `${this._content.slice(0, this._pos)}${str}${this._content.slice(this._pos)}`;
    this._pos += 1;
    this._update();
  }
}

class Keyboard {
  constructor(el) {
    this._el = el;
    this._el.classList.add('keyboard');
  }
}

class Key {
  constructor(el, opts = {}) {
    let classes = el.classList,
      ds = el.dataset;

    this._el = el;
    this[`_text${0}`] = ds.text;
    this[`_command${0}`] = ds.command;
    for (let i = 1; i < 9; i++) {
      this[`_text${i}`] = ds[`text${i}`];
      this[`_command${i}`] = ds[`command${i}`];
    }
    this._hammer = new Hammer(this._el);
    this._dispatch = this._dispatch4cross;
    this._flashDuration = 100;

    classes.add('key');

    this._hammer.
      get('swipe').
      set({direction: Hammer.DIRECTION_ALL});

    this._hammer.
      on('tap', ev => {
        ev.preventDefault(); // Prevent zoom on double-tap

        this.onCommand(ev);
      }).
      on('swipe', ev => this._dispatch(ev.angle).call(this, ev));

    for (let k in opts) {
      if (k.match(/^on[A-Z]/)) {
        this[k] = opts[k];
      }
    }
  }

  _dispatch4cross(angle) {
    if (angle > -135 && angle <= -45) {
      return this.onCommand1;
    } else if (angle > -45 && angle <= 45) {
      return this.onCommand2;
    } else if (angle > 45 && angle <= 135) {
      return this.onCommand3;
    }

    return this.onCommand4;
  }

  _dispatch4diag(angle) {
    if (angle > -90 && angle <= 0) {
      return this.onCommand1;
    } else if (angle > 0 && angle <= 90) {
      return this.onCommand2;
    } else if (angle > 90 && angle <= 180) {
      return this.onCommand3;
    }

    return this.onCommand4;
  }

  _dispatch8(angle) {
    if (angle > -158 && angle <= -113) {
      return this.onCommand8;
    } else if (angle > -113 && angle <= -68) {
      return this.onCommand1;
    } else if (angle > -68 && angle <= -23) {
      return this.onCommand2;
    } else if (angle > -23 && angle <= 23) {
      return this.onCommand3;
    } else if (angle > 23 && angle <= 68) {
      return this.onCommand4;
    } else if (angle > 68 && angle <= 113) {
      return this.onCommand5;
    } else if (angle > 113 && angle <= 158) {
      return this.onCommand6;
    }

    return this.onCommand7;
  }

  _flash(ev, index, text, command) {
    let classes = this._el.classList;

    classes.add('key-flash');
    classes.add(`key-flash${index}`);
    setTimeout(() => {
      classes.remove('key-flash');
      classes.remove(`key-flash${index}`);
    }, this._flashDuration);
  }

  _execute(ev, index, text, command) {
    console.log(JSON.stringify({
      hammer: `${ev.type} (angle: ${ev.angle.toFixed(2)})`,
      index: index,
      text: text,
      command: command
    }, null, 2));
  }

  onCommand(ev) {
    this._flash(ev, 0, this._text0, this._command0);
    this._execute(ev, 0, this._text0, this._command0);
  }
}

[1, 2, 3, 4, 5, 6, 7, 8].forEach(i => {
  Key.prototype[`onCommand${i}`] = function (ev) {
    this._flash(ev, i, this[`_text${i}`], this[`_command${i}`]);
    this._execute(ev, i, this[`_text${i}`], this[`_command${i}`]);
  };
});

class PokeKey extends Key {
  constructor(el, poke) {
    super(el);

    this._poke = poke;
  }

  _execute(ev, index, text, command) {
    //super._execute(...arguments);

    text && this._poke.insert(text);
    command && this._poke[command]();
  }
}

class PokeCharacterKey extends PokeKey {
  constructor(el, poke) {
    let classes = el.classList;

    super(el, poke);

    this._text1 = this._text1 || this._text0.toUpperCase();
    this._command2 = this._command2 || 'moveForward';
    this._text3 = this._text3 || ' ';
    this._command4 = this._command4 || 'moveBackward';

    classes.add('key-character');
  }
}

class PokeCharacterKey1 extends PokeKey {
  constructor(el, poke) {
    let classes = el.classList;

    super(el, poke);

    this._text1 = this._text1 || this._text0.toUpperCase();
    this._command2 = this._command2 || 'deleteForward';
    this._text3 = this._text3 || '\n';
    this._command4 = this._command4 || 'deleteBackward';

    classes.add('key-character');
    classes.add('key-danger');
  }
}

class PokeSymbolKey extends PokeKey {
  constructor(el, poke) {
    let classes = el.classList;

    super(el, poke);

    this._dispatch = this._dispatch4diag;

    classes.add('key-symbol');
  }
}

document.addEventListener('DOMContentLoaded', function () {
  let poke = new Poke(document.getElementById('poke')),
    keyboard = new Keyboard(document.getElementById('keyboard'));

  ['eq', 'plus', 'amp', 'ka-ching', 'num1', 'num2'].forEach(k => {
    new PokeSymbolKey(document.getElementById(`ins-${k}`), poke);
  });
  ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'].forEach(k => {
    new PokeCharacterKey(document.getElementById(`ins-${k}`), poke);
  });
  ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', 'paren'].forEach(k => {
    new PokeCharacterKey(document.getElementById(`ins-${k}`), poke);
  });
  ['z', 'x', 'c', 'v', 'b', 'n', 'm', 'dot', 'bang', 'quot'].forEach(k => {
    new PokeCharacterKey1(document.getElementById(`ins-${k}`), poke);
  });
});
    </script>
  </head>

  <body>
<h1 id="about">Poke43</h1>

<div id="poke">line</div>
<div class="flex-row-center" id="keyboard">
  <table class="frame">
    <tr>
      <td id="ins-eq"
        data-text="="
        data-text1="/"
        data-text2=">"
        data-text3="<"
        data-text4="\">=</td>
      <td id="ins-plus"
        data-text="+"
        data-text1="*"
        data-text2="%"
        data-text3="_"
        data-text4="-">+</td>
      <td id="ins-amp"
        data-text="&"
        data-text1="~"
        data-text2="#"
        data-text3="^"
        data-text4="|">&amp;</td>
      <td id="ins-ka-ching"
        data-text="$"
        data-text4="@">$</td>
      <td id="ins-num1"
        data-text="0"
        data-text1="1"
        data-text2="2"
        data-text3="3"
        data-text4="4">0</td>
      <td id="ins-num2"
        data-text="5"
        data-text1="6"
        data-text2="7"
        data-text3="8"
        data-text4="9">5</td>
    </tr>
    <tr>
      <td id="ins-q" data-text="q">q</td>
      <td id="ins-w" data-text="w">w</td>
      <td id="ins-e" data-text="e">e</td>
      <td id="ins-r" data-text="r">r</td>
      <td id="ins-t" data-text="t">t</td>
      <td id="ins-y" data-text="y">y</td>
      <td id="ins-u" data-text="u">u</td>
      <td id="ins-i" data-text="i">i</td>
      <td id="ins-o" data-text="o">o</td>
      <td id="ins-p" data-text="p">p</td>
    </tr>
    <tr>
      <td id="ins-a" data-text="a">a</td>
      <td id="ins-s" data-text="s">s</td>
      <td id="ins-d" data-text="d">d</td>
      <td id="ins-f" data-text="f">f</td>
      <td id="ins-g" data-text="g">g</td>
      <td id="ins-h" data-text="h">h</td>
      <td id="ins-j" data-text="j">j</td>
      <td id="ins-k" data-text="k">k</td>
      <td id="ins-l" data-text="l">l</td>
      <td class="key-delim" id="ins-paren" data-text="()" data-text1="{}" data-text3="[]">( )</td>
    </tr>
    <tr>
      <td id="ins-z" data-text="z">z</td>
      <td id="ins-x" data-text="x">x</td>
      <td id="ins-c" data-text="c">c</td>
      <td id="ins-v" data-text="v">v</td>
      <td id="ins-b" data-text="b">b</td>
      <td id="ins-n" data-text="n">n</td>
      <td id="ins-m" data-text="m">m</td>
      <td class="key-punct" id="ins-dot" data-text="." data-text1=";" data-text3=",">.</td>
      <td class="key-punct" id="ins-bang" data-text="!" data-text1="?" data-text3=":">!</td>
      <td class="key-delim" id="ins-quot" data-text='""' data-text1="``" data-text3="''">""</td>
    </tr>
  </table>
</div>
  </body>
</html>
